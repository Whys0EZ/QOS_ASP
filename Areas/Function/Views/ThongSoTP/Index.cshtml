@* @model IEnumerable<QOS.Areas.Function.Models.ManageOperation> *@
@* @model QOS.Areas.Function.Models.SearchOperationViewModel *@
@model string

@{
    ViewData["Title"] = "Thông Số Đo";
    Layout = "_MenuFunction";
}

<partial name="_AlertMessage" />
<div class="continer my-3">
    <h3 class="text-primary fw-bold">Thông Số Thành Phẩm</h3>

    <div class="row align-items-center mb-3">
        <!-- Bên trái -->

        <div class="col-md-6 d-flex flex-wrap gap-2">
            <form id="UploadForm" asp-area="Function" asp-action="Upload" asp-controller="ThongSoTP"
                enctype="multipart/form-data" method="post" class="d-flex align-items-center gap-2 mb-0">
                <select class="form-select w-auto" id="FormType" name="FormType">
                    <option>SPL</option>
                    <option>NIKE</option>
                    <option>UQ</option>
                    <option>US</option>
                </select>

                <a href="" id="downloadForm" class="text-decoration-none pt-2">(Tải mẫu Form)</a>

                <input type="file" name="Upload_EXCEL" class="form-control w-auto" />

                <button class="btn btn-success">
                    <i class="bi bi-upload"></i> Upload
                </button>
            </form>
        </div>

        <!-- Bên phải -->
        <div class="col-md-6 d-flex justify-content-end flex-wrap gap-2">
            <form id="SearchForm" asp-area="Function" asp-action="Search" asp-controller="ThongSoTP" method="post"
                class="d-flex align-items-center gap-2 mb-0">
                <select class="form-select w-auto" id="FactoryID" name="FactoryID">
                    <option>REG2</option>
                    <option>REG1</option>
                    <option>REG3</option>
                </select>

                <select class="form-select w-auto" id="TypeName" name="TypeName">
                    <option>ÁO</option>
                    <option>QUẦN</option>
                    <option>VÁY</option>
                    <option>JACKETS</option>
                </select>

                <input type="text" class="form-control w-auto" placeholder="MO; Style" id="Search_V" name="Search_V" />

                <button class="btn btn-warning">
                    <i class="bi bi-search"></i> Check
                </button>
            </form>
        </div>
    </div>
</div>
<div id="loadingMsg" class="alert alert-info d-none">
    Đang upload và xử lý dữ liệu...
</div>

<div class="table-responsive">
    <div id="resultArea">
        @* @Html.Raw(Model) *@
        <partial name="_ResultTable" model="Model" />
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Upload Excel bằng AJAX
    $("#UploadForm").submit(function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        $("#loadingMsg").removeClass("d-none");

        $.ajax({
            url: $(this).attr("action"),
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(result) {
                $("#loadingMsg").addClass("d-none");

                if(result.success) {
                    // Lấy Search_V từ JSON trả về
                    var searchValue = result.mo;
                    $("#Search_V").val(searchValue);

                    // Gọi action Search để hiển thị dữ liệu mới
                    $.post('@Url.Action("Search", "ThongSoTP", new { area = "Function" })',
                        {
                            FactoryID: $("#FactoryID").val(),
                            Search_V: searchValue
                        },
                        function(html) {
                            $("#resultArea").html(html);
                        }
                    );
                } else {
                    alert(result.message);
                }
            },
            error: function() {
                $("#loadingMsg").addClass("d-none");
                alert("Có lỗi khi upload!");
            }
        });
    });

    $("#SearchForm").submit(function (e) {
        e.preventDefault();
        $.post($(this).attr("action"), $(this).serialize(), function (html) {
            $("#resultArea").html(html);
        });
    });

    document.getElementById("downloadForm").addEventListener("click", function (e) {
        e.preventDefault(); // ngăn link # reload trang
        const formType = document.getElementById("FormType").value;
        let fileName = "";

        switch (formType) {
            case "SPL":
                fileName = "QOS_Form_ThongSoThanhPham_SPL.xlsx";
                break;
            case "NIKE":
                fileName = "QOS_Form_ThongSoThanhPham_NIKE.xlsx";
                break;
            case "UQ":
                fileName = "QOS_Form_ThongSoThanhPham_UQ.xlsx";
                break;
            case "US":
                fileName = "QOS_Form_ThongSoThanhPham_US.xlsx";
                break;
            default:
                alert("Chưa có form cho loại này!");
                return;
        }

        // Tải file từ thư mục wwwroot/Report/
        window.location.href = "/Report/" + fileName;
    });

</script>