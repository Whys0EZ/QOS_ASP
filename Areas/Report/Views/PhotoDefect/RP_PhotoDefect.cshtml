@removeTagHelper Microsoft.AspNetCore.Mvc.TagHelpers.OptionTagHelper, Microsoft.AspNetCore.Mvc.TagHelpers
@inject Microsoft.Extensions.Localization.IStringLocalizer<QOS.SharedResource> Localizer
@inject Microsoft.Extensions.Localization.IStringLocalizer<QOS.Areas.Report.SharedResource> ReportLocalizer
@model QOS.Areas.Report.Models.RP_PhotoDefectViewModel
@{
    ViewData["Title"] = Localizer["PhotoDefect"];
    Layout = "_MenuReport";
}
<link rel="stylesheet" href="~/css/report.css" />
<partial name="_AlertMessage" />
<div class="ddashboard-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="header-card ">
            <marquee direction="down" behavior="alternate" scrolldelay="500"><h1 class="header-title  text-center">
                <i class="bi bi-clipboard-data me-2"></i>
                QOS - @Localizer["PhotoDefect"]
            </h1></marquee>
        </div>

        <!-- Filter Section -->
        <div class="filter-card">
            <form method="get" asp-action="RP_PhotoDefect" id="filterForm">
                <div class="filter-group">
                    <div class="filter-item">
                        <label class="filter-label">@ReportLocalizer["Report"] :</label>
                        <select class="form-select" name="Report_Type" style="width: auto;">
                            <option value="Form1_BCCLC"   @(Model.Report_Type?.Trim() == "Form1_BCCLC" ? "selected" : "")  >1-@Localizer["Form1BCCLC"]</option>
                            <option value="Form2_BCCPI"   @(Model.Report_Type?.Trim() == "Form2_BCCPI" ? "selected" : "")  >2-@Localizer["Form2BCCPI"]</option>
                            <option value="Form3_BCDT"    @(Model.Report_Type?.Trim() == "Form3_BCDT" ? "selected" : "")   >3-@Localizer["Form3BCDT"]</option>
                            <option value="Form4_BCCLM"   @(Model.Report_Type?.Trim() == "Form4_BCCLM" ? "selected" : "")  >4-@Localizer["Form4BCCLM"]</option>
                            <option value="Form6_BCKCC"   @(Model.Report_Type?.Trim() == "Form6_BCKCC" ? "selected" : "")  >5-@Localizer["Form6BCCC"]</option>
                            <option value="FQC_UQ_Result" @(Model.Report_Type?.Trim() == "FQC_UQ_Result" ? "selected" : "")>6-@Localizer["FQCTracking"]</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label class="filter-label">@Localizer["Unit"]:</label>
                        <select class="form-select" name="unit" id="unitSelect" style="width: 100px;" >
                            <option value="ALL" selected>--@Localizer["Unit"]--</option>
                            @if(Model.Report_Type == "FQC_UQ_Result")
                            {
                                foreach (var unit in Model.Unit_FQC_Unit)
                                {
                                    <option value="@unit.Unit" selected="@(unit.Unit == Model.Unit)">
                                        @unit.Unit
                                    </option>
                                }
                            } else{
                                foreach (var unit in Model.Unit_List)
                                    {
                                        <option value="@unit.Unit" selected="@(unit.Unit == Model.Unit)">
                                            @unit.Unit
                                        </option>
                                    }
                            }
                        </select>
                    </div>
                    <div class="filter-item">
                        <label class="filter-label">@ReportLocalizer["Sewer"]:</label>
                        <input type="text" value="@(Model.Sewer == "" ? "" : Model.Sewer) " class="form-control" name="sewer" style="width: 150px;">
                    </div>

                    <div class="filter-item">
                        <label class="filter-label">MO:</label>
                        <input type="text" value="@(Model.Mo == "" ? "" : Model.Mo) " class="form-control" name="mo" style="width: 150px;">
                    </div>

                    <div class="filter-item">
                        <label class="filter-label">@Localizer["Date"]:</label>
                        <input type="date" class="form-control" name="dateFrom" 
                                value="@(Model.DateFrom.ToString("yyyy-MM-dd"))" style="width: 130px;">
                    </div>

                    <div class="filter-item" style="margin-top: 20px;">
                        <span>-</span>
                    </div>

                    <div class="filter-item">
                        <label class="filter-label">&nbsp;</label>
                        <input type="date" class="form-control" name="dateEnd" 
                                value="@(Model.DateEnd.ToString("yyyy-MM-dd"))" style="width: 130px;">
                    </div>

                    <div class="filter-item mt-auto">
                        <label class="filter-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-1"></i> @Localizer["Search"]
                        </button>
                    </div>

                    <div class="filter-item mt-auto">
                        <label class="filter-label">&nbsp;</label>
                        <button type="button" class="btn btn-success" onClick="Export2Excel_Click();">
                            <i class="bi bi-file-earmark-excel me-1"></i> @Localizer["ExportExcel"]
                        </button>
                    </div>
                </div>
            </form>
        </div>
        @if (Model.ReportData != null && Model.ReportData.Any())
        {
             var reportName = "";
             var imgPath = "/upload/Photos/";
            if (Model.Report_Type?.Trim() == "Form1_BCCLC")
            {
                reportName = Localizer["Form1BCCLC"];
                imgPath += "Form1_BCCLC/";
            } 
            else if (Model.Report_Type == "Form2_BCCPI")
            {
                reportName = Localizer["Form2BCCPI"];
                imgPath += "Form2_CPI/";
            } 
            else if (Model.Report_Type == "Form3_BCDT")
            {
                reportName = Localizer["Form3BCDT"];
                imgPath += "Form3_BCDT/";
            }
            else if (Model.Report_Type == "Form4_BCCLM")
            {
                reportName = Localizer["Form4BCCLM"];
                imgPath += "Form4_BCCLM/";
            }
            else if (Model.Report_Type == "Form6_BCKCC")
            {
                reportName = Localizer["Form6BCCC"];
                imgPath += "Form6_BCKCC/";
            }
            else if (Model.Report_Type == "FQC_UQ_Result")
            {
                reportName = Localizer["FQCTracking"];
                imgPath += "FQC/";
            }
            <div class="chart-card">
                <h2 class="chart-title">@ReportLocalizer["Detail_Img"] @reportName</h2>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-striped" id='headerTable'>
                        <thead class="table-primary text-center align-middle">
                            <th>@Localizer["No"]</th>
                            <th>@ReportLocalizer["IDReport"]</th>
                            <th>@Localizer["Unit"]</th>
                            <th>MO</th>
                            <th>@ReportLocalizer["CheckQty"] / @ReportLocalizer["Qty"]</th>
                            <th>@ReportLocalizer["FaultTotal"]</th>
                            <th>@ReportLocalizer["Status"]</th>
                            <th>@Localizer["AuditTime"]</th>
                            <th>@ReportLocalizer["ImgError"]</th>
                            <th>@ReportLocalizer["Fault"]</th>
                            <th>@ReportLocalizer["Sewer"]/ @ReportLocalizer["CutLeader"]</th>
                            <th>@Localizer["UserUpdate"]</th>
                            <th>@Localizer["LastUpdate"]</th>
                        </thead>
                        <tbody>
                            @{
                                var i = 1;
                                foreach (var row in Model.ReportData)
                                {
                                    
                                    bool reAudit = row["Re_Audit"] != DBNull.Value && Convert.ToBoolean(row["Re_Audit"]);
                                    string cssClass = reAudit ? "Circles_Red" : "Circles_Green";
                                    
                                    <tr>
                                        <td>@i</td>
                                        <td> <span style="text-decoration: underline; cursor: pointer; color:blue;" onclick="showDetails('@row["ID"]')">@row["ID"]</span></td>
                                        <td>@row["Unit"]</td>
                                        <td>@row["MO"] - @row["Color"]</td>
                                        <td>@row["Check_Qty"] / @row["Qty"]</td>
                                        <td>@row["Total_Fault_QTY"]</td>
                                        <td style="text-align: center;"><div class="@cssClass"></div></td>
                                        <td>@row["Audit_Time"]</td>

                                        <td>
                                            @if (!object.ReferenceEquals(row["Photo_URL"], null))
                                            {
                                                var photos = row["Photo_URL"]?.ToString()?.Split(';', StringSplitOptions.RemoveEmptyEntries);
                                                foreach (var photo in photos)
                                                {
                                                    <img src="@($"{imgPath}{photo}")" alt="Defect Photo" style="width: 100px; height: auto; margin: 2px; border: 1px solid #ccc;"  onclick='Show_Photo("@($"{imgPath}{photo}")")'/>
                                                    @* <a href="@Url.Content($"~/{imgPath}{photo}")" target="_blank"> *@
                                                    @* <a href="@($"{imgPath}{photo}")" target="_blank">
                                                        <img src="@($"{imgPath}{photo}")" alt="Defect Photo" style="width: 100px; height: auto; margin: 2px; border: 1px solid #ccc;"  onclick='Show_Photo("@($"{imgPath}{photo}")")'/>
                                                    </a> *@
                                                }
                                            }
                                            else
                                            {
                                                <span>Không có hình ảnh</span>
                                            }
                                        </td>
                                        <td>@row["Fault_List_VN"]</td>
                                        <td>@row["Sewer"]</td>
                                        <td>@row["UserUpdate"]- @row["FullName"]</td>
                                        <td>@row["LastUpdate"]</td>
                                    </tr>
                                    i++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>

        } 
        else {
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                @Localizer["Nodata"]
            </div>
        }

    </div>
</div>

<!-- Modal Show anh loi -->
<div id="Modal_Photo" class="modal" style="height: 100%;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-center">
                <span class="close" id="close_Modal_Photo" style="font-size:2rem;cursor:pointer;">&times;</span>
                <h2 class="modal-title w-100" style="text-align: center; text-transform: uppercase;">@ReportLocalizer["ImgError"]</h2>
            </div>
            <div class="modal-body" style="text-align: center;">
                <img src="" style="width: 90%" id="Fault_Photo" align="center">
            </div>
        </div>
    </div>
</div>

 @* modal-fullscreen *@
<div class="modal fade" id="Form6Modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white text-center text-uppercase">
                <h5 class="modal-title">@ReportLocalizer["modal-title"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ModalRP_Form6">
                <!-- Nội dung chi tiết sẽ load vào đây -->
            </div>
        </div>
    </div>
</div>

<script>
    function Show_Photo(img) {
        var modal = document.getElementById('Modal_Photo');
        var span = document.getElementById('close_Modal_Photo');
        modal.style.display = "block";
        
        document.getElementById("Fault_Photo").src = '' + img;
        span.onclick = function () {
            modal.style.display = "none";
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }

    function Export2Excel_Click() {

        var tab_text = "<table border='1px'><tr>";
        var textRange = '';
        var j = 0;
        var tab = document.getElementById('headerTable'); // id of table
        var row = tab.rows[0];

        // Tiêu đề 
        tab_text += "<tr>";
        for (var l = 0; l < row.cells.length; l++) {

            tab_text += "<td bgcolor='#87AFC6'>" + row.cells[l].innerHTML + "</td>";

        }
        tab_text += "</tr>";
        j++;

        //dữ liệu bảng
        for (; j < tab.rows.length; j++) {

            var row = tab.rows[j];
            tab_text += "<tr>";
            for (var l = 0; l < row.cells.length; l++) {

                tab_text += "<td >" + row.cells[l].innerHTML + "</td>";

            }
            tab_text += "</tr>";
        }

        tab_text = tab_text + "</table>";

        var a = document.createElement('a');
        var data_type = 'data:application/vnd.ms-excel';
        a.href = data_type + ', ' + encodeURIComponent(tab_text);
        //setting the file name
        a.download = 'Hinh_anh_loi.xls';
        //triggering the function
        a.click();
        //just in case, prevent default behaviour
        e.preventDefault();
    }

    function showDetails(id) {
        var report_type = '@Model.Report_Type';
        if (report_type == 'Form1_BCCLC')
        {
            $.get('@Url.Action("DetailForm1", "Form1BCCLC", new { area = "Report" })',
                { id: id },
                function (data) {
                    if (data) {
                        // inset info
                        $("#ModalRP_Form6").html(data);
                        var modal = new bootstrap.Modal(document.getElementById('Form6Modal'));
                        var unit = $("#ModalRP_Form6").find("#UnitField").val();
                        //$(".modal-title").text("Chi tiết báo cáo - Chuyền : " + unit);
                        $(".modal-title").text(
                            @Html.Raw(Json.Serialize($"{ReportLocalizer["modal-title"]} - {Localizer["Line"]}: ")) + unit
                        );

                        modal.show();
                    }
                });
        }
        if (report_type == 'Form2_BCCPI')
        {
            $.get('@Url.Action("DetailForm2", "Form2BCCPI", new { area = "Report" })',
                { id: id },
                function (data) {
                    if (data) {
                        // inset info
                        $("#ModalRP_Form6").html(data);
                        var modal = new bootstrap.Modal(document.getElementById('Form6Modal'));
                        var unit = $("#ModalRP_Form6").find("#UnitField").val();
                        //$(".modal-title").text("Chi tiết báo cáo - Chuyền : " + unit);
                        $(".modal-title").text(
                            @Html.Raw(Json.Serialize($"{ReportLocalizer["modal-title"]} - {Localizer["Line"]}: ")) + unit
                        );

                        modal.show();
                    }
                });
        }
        if (report_type == 'Form3_BCDT')
        {
            $.get('@Url.Action("DetailForm3", "Form3BCDT", new { area = "Report" })',
                { id: id },
                function (data) {
                    if (data) {
                        // inset info
                        $("#ModalRP_Form6").html(data);
                        var modal = new bootstrap.Modal(document.getElementById('Form6Modal'));
                        var unit = $("#ModalRP_Form6").find("#UnitField").val();
                        //$(".modal-title").text("Chi tiết báo cáo - Chuyền : " + unit);
                        $(".modal-title").text(
                            @Html.Raw(Json.Serialize($"{ReportLocalizer["modal-title"]} - {Localizer["Line"]}: ")) + unit
                        );

                        modal.show();
                    }
                });
        }
        if (report_type == 'Form6_BCKCC')
        {
            $.get('@Url.Action("DetailForm6", "Form6BCCC", new { area = "Report" })',
                { id: id },
                function (data) {
                    if (data) {
                        // inset info
                        $("#ModalRP_Form6").html(data);
                        var modal = new bootstrap.Modal(document.getElementById('Form6Modal'));
                        var unit = $("#ModalRP_Form6").find("#UnitField").val();
                        //$(".modal-title").text("Chi tiết báo cáo - Chuyền : " + unit);
                        $(".modal-title").text(
                            @Html.Raw(Json.Serialize($"{ReportLocalizer["modal-title"]} - {Localizer["Line"]}: ")) + unit
                        );

                        modal.show();
                    }
                });
        }
        if (report_type == 'Form4_BCCLM') {
            $.get('@Url.Action("DetailForm4", "Form4BCCLM", new { area = "Report" })',
                { id: id },
                function (data) {
                    if (data) {
                        // inset info
                        $("#ModalRP_Form6").html(data);
                        var modal = new bootstrap.Modal(document.getElementById('Form6Modal'));
                        var unit = $("#ModalRP_Form6").find("#UnitField").val();
                        //$(".modal-title").text("Chi tiết báo cáo - Chuyền : " + unit);
                        $(".modal-title").text(
                            @Html.Raw(Json.Serialize($"{ReportLocalizer["modal-title"]} - {Localizer["Line"]}: ")) + unit
                        );

                        modal.show();
                    }
                });
        }
    }

</script>
