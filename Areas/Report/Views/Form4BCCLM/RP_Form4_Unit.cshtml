@model QOS.Areas.Report.Models.RP_Form4_UnitViewModel
@{
    ViewData["Title"] = "BCCLM_Unit";
    Layout = "_MenuReport";
}

<partial name="_AlertMessage" />
<div class="w-100 px-2 my-3">
    <div class="row align-items-center g-2">
        <!-- Tiêu đề -->
        <div class="col-12 col-md-5">
            <h3 class="text-primary fw-bold mb-0 text-center text-md-start">
                QOS - BÁO CÁO CHẤT LƯỢNG CHUYỀN MAY @Model.Unit
            </h3>
        </div>

        <!-- Form tìm kiếm -->
        <div class="col-12 col-md-7">
            <form id="SearchForm" asp-area="Report" asp-action="RP_Form4_Unit"
                  asp-controller="Form4BCCLM" method="get"
                  class="row g-2 justify-content-end align-items-center">

                <!-- Unit -->
                <div class="col-12 col-sm-6 col-md-2">
                    <select class="form-select" id="Unit" name="Unit" asp-for="Unit"
                        asp-items="@(new SelectList(Model.Unit_List, "Unit", "Unit", Model.Unit))">
                        <option value="ALL">Chọn Unit</option>
                    </select>
                </div>

                <!-- Ngày từ -->
                <div class="col-6 col-md-2">
                    <input type="date" id="dateFrom" name="dateFrom" class="form-control"
                        value="@Model.DateFrom.ToString("yyyy-MM-dd")" />
                </div>

                <!-- Ngày đến -->
                <div class="col-6 col-md-2">
                    <input type="date" id="dateEnd" name="dateEnd" class="form-control"
                        value="@Model.DateEnd.ToString("yyyy-MM-dd")" />
                </div>

                <!-- Buttons -->
                <div class="col-12 col-md-6 d-flex flex-wrap gap-2">
                    <button class="btn btn-warning flex-fill" type="submit">Check</button>
                    <button class="btn btn-secondary flex-fill" type="reset">Nhập&nbsp;Lại</button>
                    <button type="button" class="btn btn-primary flex-fill" id="ExportExcel">Tải&nbsp;Excel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>Chưa kiểm tra</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>Không có lỗi</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-warning rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>Lỗi nhẹ</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-danger rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>Lỗi nặng</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Kết quả -->
    <div class="row">
        <div class="col-12" id="TableContainer">
            @if (Model.LineDetails.Any())
            {
                <table class="table table-bordered table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width:50px;">LINE</th>
                            @foreach (var col in Model.ColumnHeaders)
                            {
                                <th style="width:50px;">@col</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Model.LineDetails)
                        {
                            <tr>
                                <td class="text-center">@row.Line</td>
                                @foreach (var col in Model.ColumnHeaders)
                                {
                                    var status = row.StatusByStep[col];
                                    var cssClass = status switch
                                    {
                                        "red" => "Circles_Red",
                                        "green" => "Circles_Green",
                                        "yellow" => "Circles_Yellow",
                                        _ => "Circles_None"
                                    };

                                    <td class="text-center">
                                        <div class="@cssClass"
                                            onclick="showHistoryRPLine('@row.Line','@col.Replace("S", "")','@Model.DateFrom.ToString("yyyy-MM-dd")','@Model.DateEnd.ToString("yyyy-MM-dd")');">
                                            &nbsp;
                                        </div>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else if (ViewData["Searched"] != null)
            {
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle"></i> Không tìm thấy dữ liệu trong khoảng thời gian đã chọn.
                </div>
            }
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="fw-bold">Đang tải dữ liệu...</div>
                <small class="text-muted">Vui lòng chờ trong giây lát</small>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
@* modal-fullscreen *@
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen ">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="text-align: center; text-transform: uppercase;" class="modal-title">Lịch sử kiểm tra chất lượng may xưởng - <span id="lineCodeTitle"></span></h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body " id="historyContent">
                <!-- History content will be loaded here -->
                
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Export Excel functionality
    document.getElementById('ExportExcel').addEventListener('click', function() {
        var form = document.getElementById('SearchForm');
        var formData = new FormData(form);
        
        // Show loading
        var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();
        
        // Create export form
        var exportForm = document.createElement('form');
        exportForm.method = 'POST';
        exportForm.action = '@Url.Action("ExportExcel", "Form4BCCLM", null, "Report")';
        exportForm.style.display = 'none';
        
        // Add form data
        for (var pair of formData.entries()) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = pair[0];
            input.value = pair[1];
            exportForm.appendChild(input);
        }
        
        document.body.appendChild(exportForm);
        exportForm.submit();
        document.body.removeChild(exportForm);
        
        // Hide loading after a delay
        setTimeout(function() {
            loadingModal.hide();
        }, 2000);
    });
});

function resetForm() {
    document.getElementById('Unit').value = 'ALL';
    document.getElementById('dateFrom').value = '@DateTime.Now.AddDays(-7).ToString("yyyy-MM-dd")';
    document.getElementById('dateEnd').value = '@DateTime.Now.ToString("yyyy-MM-dd")';
}

function showHistoryRPLine(lineCode,col, dateF, dateT) {
    document.getElementById('lineCodeTitle').textContent = lineCode;
    
    // You can implement AJAX call here to load detailed history
    var historyContent = document.getElementById('historyContent');
    historyContent.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div>Đang tải lịch sử cho line ${lineCode}...</div>
            <small class="text-muted">Từ ${dateF} đến ${dateT}</small>
        </div>
    `;
    
    var historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
    historyModal.show();
    $.ajax({
        url: '/Report/Form4BCCLM/GetSewerLineHistory',
        type: 'GET',
        data: {
            lineCode: lineCode,
            position: col,
            dateFrom: dateF || new Date().toISOString().slice(0, 10),
            dateEnd: dateT   || new Date().toISOString().slice(0, 10)
        },
        success: function (html) {
            $("#historyContent").html(html);
        },
        error: function () {
            $("#historyContent").html('<div class="alert alert-danger">Lỗi tải dữ liệu</div>');
        }
    });
}

// Show loading on form submit
document.getElementById('SearchForm').addEventListener('submit', function() {
    var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
});
</script>

@* <script>
 $.ajax({
        url: '/Report/Form4BCCLM/GetLineHistory',
        type: 'GET',
        data: {
            lineCode: lineCode,
            dateFrom: dateF || new Date().toISOString().slice(0, 10), // nếu rỗng thì mặc định hôm nay
            dateEnd: dateT   || new Date().toISOString().slice(0, 10)
        },
        success: function (res) {
          
            if (res.success) {
                console.log("res.data:", res.data);
                if (!res.data || res.data.length === 0) {
                    historyContent.innerHTML = `
                        <div class="alert alert-warning">
                            Không có dữ liệu cho line ${lineCode}.
                        </div>`;
                    return;
                }
                let content = `
                    <div class="alert ">
                        <table class="table table-striped" align="center" border="0" cellpadding="0" cellspacing="0" width="100%" style="position:relative; width:100%;">
                        <thead class="table-primary">
                            <tr class="Title_TB" style="font-size: 1.5em!important;">
                                <th style="width:25px;;" >STT</th>
                                <th style="width:230px;" >Báo Cáo</th>
                                <th style="width:200px;" >Công đoạn</th>
                                <th style="width:250px;" >Sewer</th>
                                <th style="width:100px;" >SL Lỗi/SL Kiểm</th>
                                <th style="width:60px;" >Trạng thái</th>
                                <th style="width:60px;" >Lần kiểm</th>
                                <th style="width:200px;" >Người tạo</th>
                                <th  >Thời gian kiểm</th>
                            </tr> 
                        </thead>
                        <tbody>               

                    
                `;
                res.data.forEach((item, idx) => {
                content += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item.Report_ID}</td>
                        <td>${item.Operation_Name_VN}</td>
                        <td>${item.Sewer}</td>
                        <td>${item.Total_Fault_QTY}/${item.QTY}</td>
                        <td>${item.Status}</td>
                        <td>${item.Audit_Time}</td>
                        <td>${item.UserUpdate}- ${item.FullName}</td>
                        <td>${item.LastUpdate}</td>
                    </tr>
                `;
            });

            content += `</tbody></table> </div>`;
                historyContent.innerHTML = content;
            } else {
                historyContent.innerHTML = `<div class="alert alert-danger">${res.message}</div>`;
            }
        }
    });

    </script> *@