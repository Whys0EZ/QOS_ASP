@model QOS.Areas.Report.Models.RP_Form4_UnitViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<QOS.SharedResource> Localizer
@inject Microsoft.Extensions.Localization.IStringLocalizer<QOS.Areas.Report.SharedResource> ReportLocalizer
@{
    ViewData["Title"] = Localizer["Form4BCCLM"];
    Layout = "_MenuReport";
}

<partial name="_AlertMessage" />
<div class="w-100 px-2 my-3">
    <div class="row align-items-center g-2">
        <!-- Tiêu đề -->
        <div class="col-12 col-md-5">
            <h3 class="text-primary fw-bold mb-0 text-center text-md-start">
                QOS - @Localizer["Form4BCCLM"] @Model.Unit
            </h3>
        </div>

        <!-- Form tìm kiếm -->
        <div class="col-12 col-md-7">
            <form id="SearchForm" asp-area="Report" asp-action="RP_Form4_Unit"
                  asp-controller="Form4BCCLM" method="get"
                  class="row g-2 justify-content-end align-items-center">

                <!-- Unit -->
                <div class="col-12 col-sm-6 col-md-2">
                    <select class="form-select" id="Unit" name="Unit" asp-for="Unit"
                        asp-items="@(new SelectList(Model.Unit_List, "Unit", "Unit", Model.Unit))">
                        <option value="ALL">--@Localizer["Unit"]--</option>
                    </select>
                </div>

                <!-- Ngày từ -->
                <div class="col-6 col-md-2">
                    <input type="date" id="dateFrom" name="dateFrom" class="form-control"
                        value="@Model.DateFrom.ToString("yyyy-MM-dd")" />
                </div>

                <!-- Ngày đến -->
                <div class="col-6 col-md-2">
                    <input type="date" id="dateEnd" name="dateEnd" class="form-control"
                        value="@Model.DateEnd.ToString("yyyy-MM-dd")" />
                </div>

                <!-- Buttons -->
                <div class="col-12 col-md-6 d-flex flex-wrap gap-2">
                    <button class="btn btn-warning flex-fill" type="submit">@Localizer["Check"]</button>
                    <button class="btn btn-secondary flex-fill" type="reset">@Localizer["Reset"]</button>
                    <button type="button" class="btn btn-primary flex-fill" id="ExportExcel">@Localizer["ExportExcel"]</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Legend -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>@ReportLocalizer["circle_notcheck"]</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>@ReportLocalizer["circle_notfault"]</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-warning rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>@ReportLocalizer["circle_minor"]</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-danger rounded-circle me-2" style="width: 15px; height: 15px;">&nbsp;</span>
                    <small>@ReportLocalizer["circle_serious"]</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Kết quả -->
    <div class="row">
        <div class="col-12 table-responsive" id="TableContainer">
            @if (Model.LineDetails.Any())
            {
                <table class="table table-bordered table-hover align-middle ">
                    <thead>
                        <tr>
                            <th style="width:50px; position: sticky;left: 0; z-index: 5; background: #54aafaff;" >@Localizer["Line"]</th>
                            @foreach (var col in Model.ColumnHeaders)
                            {
                                <th style="width:50px;">@col</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Model.LineDetails)
                        {
                            <tr>
                                <td class="text-center" style ="position: sticky;left: 0; z-index: 5; background: #54aafaff;">@row.Line</td>
                                @foreach (var col in Model.ColumnHeaders)
                                {
                                    var status = row.StatusByStep[col];
                                    var cssClass = status switch
                                    {
                                        "red" => "Circles_Red",
                                        "green" => "Circles_Green",
                                        "yellow" => "Circles_Yellow",
                                        _ => "Circles_None"
                                    };

                                    <td class="text-center">
                                        <div class="@cssClass"
                                            onclick="showHistoryRPLine('@row.Line','@col.Replace("S", "")','@Model.DateFrom.ToString("yyyy-MM-dd")','@Model.DateEnd.ToString("yyyy-MM-dd")');">
                                            &nbsp;
                                        </div>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else if (ViewData["Searched"] != null)
            {
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle"></i> @ReportLocalizer["info_data"]
                </div>
            }
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">@ReportLocalizer["Loading"]</span>
                </div>
                <div class="fw-bold">@ReportLocalizer["Loadingdata"]</div>
                <small class="text-muted">@ReportLocalizer["Loadingplease"]</small>
            </div>
        </div>
    </div>
</div>

<!-- History Modal -->
@* modal-fullscreen *@
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen ">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h2 style="text-align: center; text-transform: uppercase;" class="modal-title">@ReportLocalizer["HistoryInline"] - <span id="lineCodeTitle"></span></h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body " id="historyContent">
                <!-- History content will be loaded here -->
                
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Export Excel functionality
    document.getElementById('ExportExcel').addEventListener('click', function() {
        var form = document.getElementById('SearchForm');
        var formData = new FormData(form);
        
        // Show loading
        var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();
        
        // Create export form
        var exportForm = document.createElement('form');
        exportForm.method = 'POST';
        exportForm.action = '@Url.Action("ExportExcel_Unit", "Form4BCCLM", null)';
        exportForm.style.display = 'none';
        
        // Add form data
        for (var pair of formData.entries()) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = pair[0];
            input.value = pair[1];
            exportForm.appendChild(input);
        }
        
        document.body.appendChild(exportForm);
        exportForm.submit();
        document.body.removeChild(exportForm);
        
        // Hide loading after a delay
        setTimeout(function() {
            loadingModal.hide();
        }, 2000);
    });
});

function resetForm() {
    document.getElementById('Unit').value = 'ALL';
    document.getElementById('dateFrom').value = '@DateTime.Now.AddDays(-7).ToString("yyyy-MM-dd")';
    document.getElementById('dateEnd').value = '@DateTime.Now.ToString("yyyy-MM-dd")';
}

function showHistoryRPLine(lineCode, col, dateF, dateT) {
    const titleEl = document.getElementById('lineCodeTitle');
    if (titleEl) titleEl.textContent = lineCode;

    const historyContent = document.getElementById('historyContent');
    if (historyContent) {
        historyContent.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-primary mb-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Đang tải lịch sử cho line ${lineCode}...</div>
                <small class="text-muted">Từ ${dateF} đến ${dateT}</small>
            </div>
        `;
    }

    const modalEl = document.getElementById('historyModal');
    const historyModal = bootstrap.Modal.getOrCreateInstance(modalEl);
    historyModal.show();

    $.ajax({
        url: '/Report/Form4BCCLM/GetSewerLineHistory',
        type: 'GET',
        data: { lineCode: lineCode, position: col, dateFrom: dateF, dateEnd: dateT },
        success: (html) => $("#historyContent").html(html),
        error: () => $("#historyContent").html('<div class="alert alert-danger">Lỗi tải dữ liệu</div>')
    });
}

// Show loading on form submit
document.getElementById('SearchForm').addEventListener('submit', function() {
    var loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
});
</script>
