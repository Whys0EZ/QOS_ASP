@using System.Text.Json
@model QOS.Areas.Report.Models.OQLEndLineViewModel
@{
	ViewData["Title"] = "DAILY OQL ENDLINE";
	Layout = "_MenuReport";
}
<link rel="stylesheet" href="~/css/report.css" />
<partial name="_AlertMessage" />


<style>
    .oql-container {
        padding: 20px;
        background: #f5f5f5;
    }
    
    .oql-header {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #003d82;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .oql-title {
        color: #003d82;
        font-size: 28px;
        font-weight: bold;
        margin: 0;
    }
    
    .filter-section {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filter-section label {
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    
    .filter-section select {
        padding: 8px 12px;
        border: 2px solid #003d82;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        min-width: 100px;
    }
    
    .btn-submit {
        background: #003d82;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        font-size: 18px;
    }
    
    .btn-submit:hover {
        background: #002a5c;
    }
    
    .btn-download {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-download:hover {
        background: #218838;
    }
    
    .oql-table-wrapper {
        overflow-x: auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .oql-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    
    .oql-table th,
    .oql-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
        white-space: nowrap;
    }
    
    .oql-table thead th {
        background: #003d82;
        color: white;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .oql-table th.date-header {
        min-width: 80px;
    }
    
    .oql-table th.day-header {
        min-width: 45px;
        padding: 5px;
    }
    
    .oql-table tbody tr:nth-child(even) {
        background: #f9f9f9;
    }
    
    .oql-table tbody tr:hover {
        background: #e8f4f8;
    }
    
    .oql-table td.line-name {
        text-align: left;
        font-weight: bold;
        background: #f0f0f0;
        position: sticky;
        left: 0;
        z-index: 5;
    }
    
    .oql-table td.target-cell {
        background: #e8e8e8;
        font-weight: bold;
    }
    
    .oql-table td.value-cell {
        font-weight: 600;
        color: #d32f2f;
    }
    
    .oql-table td.avg-cell {
        background: #f5f5f5;
        font-weight: bold;
        color: #1976d2;
    }
    
    .oql-table th.red-header {
        background: #d32f2f !important;
    }
    
    .oql-table th.empty-header {
        background: #e0e0e0 !important;
    }
    
    .oql-table td.empty-cell {
        background: #f5f5f5;
    }
    
    .download-link {
        color: #28a745;
        text-decoration: none;
        font-weight: bold;
        font-size: 16px;
        display: inline-block;
        margin-bottom: 10px;
    }
    
    .download-link:hover {
        text-decoration: underline;
    }
    .empty-cell { background: #f8f9fa; color: #aaa; }
    .low-cell { background: #ffebee; color: #c62828; font-weight: bold; }
    .medium-cell { background: #fff3e0; color: #ef6c00; }
    .high-cell { background: #e8f5e9; color: #2e7d32; font-weight: bold; }
    table td, table th {
        text-align: center;
        padding: 6px 10px;
        border: 1px solid #ddd;
    }
    .line-name {
        font-weight: 600;
        background-color: #f1f1f1;
    }
</style>

<div class="oql-container">
    <div class="oql-header">
        <h1 class="oql-title">QOS - DAILY OQL ENDLINE</h1>
    </div>
    
    <a asp-action="DownloadReport" 
       asp-route-unit="@Model.SelectedUnit" 
       asp-route-month="@Model.SelectedMonth" 
       asp-route-year="@Model.SelectedYear" 
       class="download-link">Download File Report</a>
    
    <form method="get" class="filter-section">
        <label>UNIT:</label>
        <select name="unit" asp-for="SelectedUnit">
            @if (Model.Zone.Any())
            {
                foreach (var zone in Model.Zone)
                {
                    <option value="@($"Z{zone}")" selected="@($"Z{zone}" == Model.SelectedUnit)">@zone</option>
                }
            }
            @if (Model.DistinctUnits.Any())
            {
                foreach (var u in Model.DistinctUnits)
                {
                    <option value="@u.Unit" selected="@(u.Unit == Model.SelectedUnit)">@u.Unit</option>
                }
            }
            
        </select>
        
        <label>Tháng:</label>
        <select name="month" asp-for="SelectedMonth">
            @for (int i = 1; i <= 12; i++)
            {
                <option value="@i">@i</option>
            }
        </select>
        
        <label>Năm:</label>
        <select name="year" asp-for="SelectedYear">
            @for (int i = DateTime.Now.Year; i >= 2015; i--)
            {
                <option value="@i">@i</option>
            }
        </select>
        
        <button type="submit" class="btn-submit">🔍</button>
        <button type="button" class="btn-download">📥 Nhập Lại</button>
    </form>
    
    <div class="oql-table-wrapper">
        <table class="oql-table">
            <thead>
                <tr>
                    <th colspan="2" class="date-header">Date</th>
                    @for (int day = 1; day <= 31; day++)
                    {
                        var isRed = day == 5 || day == 12 || day == 19 || day == 26;
                        var isEmpty = day == 4 || day == 11 || day == 18 || day == 25;
                        var headerClass = isRed ? "red-header" : (isEmpty ? "empty-header" : "");
                        <th class="day-header @headerClass">@day.ToString("D2")</th>
                    }
                </tr>
                <tr>
                    <th  class="date-header">Line</th>
                    <th class="date-header">Target<br/>OQL</th>
                    @for (int day = 1; day <= 31; day++)
                    {
                        <th class="day-header">5%</th>
                    }
                </tr>
            </thead>
            <tbody>
               
                @foreach (var unitGroup in Model.Lines.GroupBy(l => l.LineName.Substring(0, 3)))
                {
                    @* <!-- Tính trung bình môi Unit --> *@
                    var dayCount = unitGroup.First().DailyValues.Count;
                    var avgValues = new List<double?>();

                    for (int i = 0; i < dayCount; i++)
                    {
                        var values = unitGroup
                            .Select(x => x.DailyValues[i])
                            .Where(v => v.HasValue)
                            .Select(v => v.Value)
                            .ToList();

                        avgValues.Add(values.Any() ? values.Average() : (double?)null);
                    }

                    <!-- Tiêu đề Unit -->
                    <tr class="unit-header">
                        <td colspan="100" style="background:#1565c0;color:white;font-weight:bold;">
                            Unit: @unitGroup.Key
                        </td>
                    </tr>

                    <!-- Các dòng line thuộc Unit đó -->
                    @foreach (var line in unitGroup)
                    {
                        <tr>
                            <td colspan="2" class="line-name">@line.LineName</td>
                            @foreach (var value in line.DailyValues)
                            {
                                var cellClass = value == null ? "empty-cell" : "value-cell";
                                <td class="@cellClass">
                                    @(value == null ? "" : value.Value.ToString("F1") + "%")
                                </td>
                            }
                        </tr>
                    }
  
                    
                    

                    <tr style="background:#e3f2fd;">
                        <td class="line-name" style="background:#1976d2;color:white;">Average</td>
                        <td class="target-cell"></td>
                        @foreach (var avg in avgValues)
                        {
                            <td class="avg-cell">@(avg == null ? "" : avg.Value.ToString("F1") + "%")</td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


<script>
    // Tự động submit form khi thay đổi select
    document.querySelectorAll('.filter-section select').forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
</script>
