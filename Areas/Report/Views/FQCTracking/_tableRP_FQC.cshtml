@model QOS.Areas.Report.Models.FQCTrackingDetailViewModel
@inject Microsoft.Extensions.Localization.IStringLocalizer<QOS.SharedResource> Localizer
@inject Microsoft.Extensions.Localization.IStringLocalizer<QOS.Areas.Report.SharedResource> ReportLocalizer


<style>
    .form-label { font-weight: 600; }
    .table-custom th, .table-custom td { vertical-align: middle; }
    .table-custom input, .table-custom select { width: 100%; }
    .section-title { font-size: 1.1rem; font-weight: bold; margin-top: 1.5rem; color: #198754; }
    textarea { border-radius: 8px; border: 1px solid #ced4da; padding: 8px; }
    .led-img { width: 60px; border-radius: 50%; border: 2px solid #dee2e6; }
    .modal-content { border-radius: 12px; }
    .modal-header { border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .btn-action { margin: 0 10px; }
    .photo-thumb { width: 90px; margin: 5px; border-radius: 8px; border: 1px solid #dee2e6; cursor: pointer; transition: box-shadow .2s; }
    .photo-thumb:hover { box-shadow: 0 0 8px #198754; }
    .form-check-input { zoom: 1.5; }
    .form-section { background: #f8f9fa; border-radius: 12px; padding: 18px 24px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px #e9ecef; }
</style>

<form id="FQCReport" method="post" asp-action="CreateReport_FQC" asp-controller="Report" asp-area="Report">
    <input type="hidden" id="ReportID" name="ReportID" value="@Model.Detail.ID_Result"/>
    <div class="form-section">
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">@Localizer["Unit"]</label>
                <div class="input-group">
                    <input id="UnitField" class="form-control" value="@Model.Detail.Unit" placeholder="Unit"/>
                    
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label">@ReportLocalizer["Sewer"]</label>
                <input class="form-control" value="@Model.Detail.CreatedBy"/>
            </div>
            <div class="col-md-4">
                <label class="form-label">@ReportLocalizer["Operation"]</label>
                <input class="form-control" value="@Model.Detail.Operation"/>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">SO</label>
                <input class="form-control" value="@Model.Detail.SO" />
            </div>
            <div class="col-md-4">
                <label class="form-label">PO</label>
                <input class="form-control" value="@Model.Detail.PO" />
            </div>
            <div class="col-md-4">
                <label class="form-label">OQL</label>
                <input class="form-control" value="@Model.Detail.OQL" />
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">@ReportLocalizer["Qty"]</label>
                <input class="form-control" value="@Model.Detail.QTY"/>
            </div>
            <div class="col-md-4">
                <label class="form-label">@ReportLocalizer["CheckQty"]</label>
                <input class="form-control" value="@Model.Detail.Check_QTY"/>
            </div>
            <div class="col-md-4">
                <label class="form-label">@ReportLocalizer["FaultTotal"]</label>
                <input class="form-control" value="@Model.Detail.Total_Fault_QTY"/>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">shipMode</label>
                <input class="form-control" value="@Model.Detail.shipMode"/>
            </div>
            <div class="col-md-4">
                <label class="form-label">Item_No</label>
                <input class="form-control" value="@Model.Detail.Item_No"/>
            </div>
            <div class="col-md-4">
                <label class="form-label">Destination</label>
                <input class="form-control" value="@Model.Detail.Destination"/>
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="section-title">@ReportLocalizer["FaultList"]</div>
        <table class="table table-bordered table-custom align-middle" style="margin-bottom: 0;" name="tblFault" id="tblFault">
            <thead class="table-light">
                <tr>
                    <th style="width:60%">@ReportLocalizer["Fault"]</th>
                    <th style="width:40%">@ReportLocalizer["FaultQty"]</th>
                </tr>
            </thead>
            <tbody>
            @for (int i = 0; i < Model.SelectedFaults.Count; i++)
            {
                var selected = Model.SelectedFaults[i];
                <tr id="Fault_R@(i+1)">
                    <td>
                        <select name="optFault[@i]" id="optFault_@i"
                                class="form-select"
                                style="color:red;font-weight:bold;font-size:1em;"
                                onchange="Turn_Led();">
                            <option value="loi-0">--Không có lỗi--</option>
                            <option value="" disabled>--Lỗi Nặng--</option>
                            @foreach (var fault in Model.Faults.Where(f => f.FaultLevel == 1))
                            {
                                bool sel = (fault.FaultCode == selected.FaultCode );
                                <option value="@fault.FaultCode-@fault.FaultLevel" selected="@(sel)" >@fault.FaultNameVN</option>
                            }
                            <option value="" disabled>--Lỗi Nhẹ--</option>
                            @foreach (var fault in Model.Faults.Where(f => f.FaultLevel == 2))
                            {
                                bool sel = (fault.FaultCode == selected.FaultCode );
                                <option value="@fault.FaultCode-@fault.FaultLevel" selected="@(sel)">@fault.FaultNameVN</option>
                            }
                        </select>
                    </td>
                    <td>
                        <input type="number" name="qty[@i]" value="@selected.FaultQty" class="form-control" min="0" />
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <div class="form-section">
        <div class="section-title"><span style="color: red;">*</span> @ReportLocalizer["Remedies"] :</div>
        <textarea rows="4" cols="100" name="Remark" id="Remark" class="form-control" onClick="this.select();">@Model.Detail.Remark</textarea>
    </div>

    <div class="form-section">
        <div class="section-title"><span style="color: red;">*</span> @ReportLocalizer["quality_assessment"] :</div>
        <div class="row align-items-center text-center">
            <div class="col">
                <img id="Led_Green" src="~/images/green_@(Model.Detail.ResultStatus == "Pass" ? "On" : "Off").png" class="led-img mb-2">
                <div>
                    <input type="radio" name="rdLight" id="rdGreen" value="green" @(Model.Detail.ResultStatus == "Pass" ? "checked ='checked'" : "") class="form-check-input" autocomplete="on" />
                    @* <label for="rdGreen" class="form-check-label ms-2">Đạt</label> *@
                </div>
            </div>
            <div class="col">
                <img id="Led_Red" src="~/images/red_@(Model.Detail.ResultStatus == "Fail" ? "On" : "Off").png" class="led-img mb-2">
                <div>
                    <input type="radio" name="rdLight" id="rdRed" value="red" @(Model.Detail.ResultStatus == "Fail" ? "checked ='checked'" : "") class="form-check-input" autocomplete="on" />
                    @* <label for="rdRed" class="form-check-label ms-2">Không đạt</label> *@
                </div>
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="section-title"><span style="color: red;">*</span> @ReportLocalizer["ImgError"] :</div>
        @if(!string.IsNullOrEmpty(Model.Detail.IMG_Result))
        {
            
            var photos = Model.Detail.IMG_Result.Split(";");
            foreach(var photo in photos)
            {
                if(!string.IsNullOrEmpty(photo))
                {
                    @* <img src="/upload/Photos/FQC_BCCC/@photo" class="photo-thumb" onclick='Show_Photo("@photo")'/> *@
                    <img src="/upload/Photos/FQC/@photo" class="photo-thumb" onclick='Show_Photo("/upload/Photos/FQC/@photo")'/>
                }
            }
        }
    </div>

    <div class="form-section">
        
        <div class="section-title">
            <span style="color: red;">*</span> @ReportLocalizer["ReAudit"] :
            <input style="margin-top:0" type="checkbox" name="Re_Audit" id="Re_Audit" value="true" @(Model.Detail.Re_Audit == true ? "checked" : "") class="form-check-input ms-2" autocomplete="on" />
       </div>
    </div>

    <div class="text-center mb-3">
        <button type="button" class="btn btn-danger btn-action" onClick="Delete_Click1();" title="Delete this report">
            <i class="bi bi-trash"></i> @ReportLocalizer["DeleteReport"]
        </button>
        <button type="button" class="btn btn-secondary btn-action" data-bs-dismiss="modal">@Localizer["Close"]</button>
    </div>
</form>

<!-- Modal Show anh loi -->
<div id="Modal_Photo" class="modal" style="height: 100%;">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-success text-center">
                <span class="close" id="close_Modal_Photo" style="font-size:2rem;cursor:pointer;">&times;</span>
                <h2 class="modal-title w-100" style="text-align: center; text-transform: uppercase;">@ReportLocalizer["ImgError"] </h2>
            </div>
            <div class="modal-body" style="text-align: center;">
                <img src="" style="width: 90%" id="Fault_Photo" align="center">
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    function Delete_Click1() {
        var reportId = $("#ReportID").val();
        if (reportId == "" || reportId == null) {
            alert("Report ID is missing!");
            return false;
        }

        if (confirm("Are you sure you want to delete this report?")) {
            $.post('@Url.Action("DeleteReport", "FQCTracking", new { area = "Report" })',
                { reportId: reportId },
                function (data) {
                    if (data.success) {
                        alert("Report deleted successfully.");
                        var Unit = $("#Unit").val();
                        var dateFrom = $("#dateFrom").val();
                        var dateEnd = $("#dateEnd").val();
                        window.location.href = '@Url.Action("FQCTracking", "FQCTracking", new { area = "Report" })' + '?Unit=' + Unit + '&dateFrom=' + dateFrom + '&dateEnd=' + dateEnd;
                    } else {
                        alert("Error deleting report: " + data.message);
                    }
                }
            );
        }
    }

    function Show_Photo(img) {
        var modal = document.getElementById('Modal_Photo');
        var span = document.getElementById('close_Modal_Photo');
        modal.style.display = "block";
        document.getElementById("Fault_Photo").src = '' + img;
        span.onclick = function () {
            modal.style.display = "none";
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    }
</script>